

<div id="agent-api"></div>

export let env_github = false

<DocIf condition={ env_github === true }>

<DocCallOut title="Note">
For the best reading experience,
please view this documentation at [elastic.co](https://www.elastic.co/guide/en/apm/agent/nodejs/current/agent-api.html)
</DocCallOut>

</DocIf>

The Elastic APM Node.js agent is a singleton. You get the agent instance by requiring either `elastic-apm-node` or `elastic-apm-node/start`. The agent is also returned by the <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="apmstart[options]">`.start()`</DocLink> method, which allows you to require and start the agent on the same line:

```js
const apm = require('elastic-apm-node').start(...)
```

If you need to access the `Agent` in any part of your codebase,
you can simply require `elastic-apm-node` to access the already started singleton.
You therefore don't need to manage or pass around the started `Agent` yourself.

<div id="apm-start"></div>

### `apm.start([options])`

Starts the Elastic APM agent for Node.js and returns itself.

<DocCallOut title="Important" color="warning">

For the APM agent to automatically instrument Node.js modules, it must be started before those modules are loaded. See <DocLink id="serverlessObservabilityApmAgentsNodejsGetStarted">Starting the agent</DocLink> for details and possible surprises with compilers/transpilers/bundlers.

</DocCallOut>

See the <DocLink id="serverlessObservabilityApmAgentsNodejsConfigure">Configuration documentation</DocLink> for available options.

<div id="apm-is-started"></div>

### `apm.isStarted()`

_Added in: v1.5.0_

Use `isStarted()` to check if the agent has already started.
Returns `true` if the agent has started,
otherwise returns `false`.

<div id="apm-get-service-name"></div>

### `apm.getServiceName()`

_Added in: v3.11.0_

Get the configured <DocLink id="serverlessObservabilityApmAgentsNodejsConfigure" section="servicename">`serviceName`</DocLink>. If a service name was not
explicitly configured, this value may have been automatically determined.
The service name is not determined until `agent.start()`, so will be `undefined`
until then. A misconfigured agent can have a `null` service name.

<div id="apm-set-framework"></div>

### `apm.setFramework(options)`

_Added in: v2.8.0_

* `options` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object[<Object>]` The following options are supported:
    * `name` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` Framework name.
    * `version` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` Framework version.
    * `overwrite` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type[<boolean>]` If set to `false`,
        the <DocLink id="serverlessObservabilityApmAgentsNodejsConfigure" section="frameworkname">`frameworkName`</DocLink> and <DocLink id="serverlessObservabilityApmAgentsNodejsConfigure" section="frameworkversion">`frameworkVersion`</DocLink> provided as <DocLink id="serverlessObservabilityApmAgentsNodejsConfigure">config options</DocLink> will not be overwritten.
        **Default:** `true`.

Set or change the <DocLink id="serverlessObservabilityApmAgentsNodejsConfigure" section="frameworkname">`frameworkName`</DocLink> or <DocLink id="serverlessObservabilityApmAgentsNodejsConfigure" section="frameworkversion">`frameworkVersion`</DocLink> after the agent has started.
These config options can also be provided as part of the <DocLink id="serverlessObservabilityApmAgentsNodejsConfigure">regular agent configuration</DocLink>.

<div id="apm-add-filter"></div>

### `apm.addFilter(fn)`

_Added in: v0.1.0_

Use `addFilter()` to supply a filter function.

Each filter function will be called just before data is being sent to the APM Server.
This will allow you to manipulate the data being sent,
for instance to remove sensitive information like passwords etc.
(Note: Filters added via `addFilter` are **not** applied to the "metadata"
object sent to the APM Server -- use `addMetadataFilter` instead.)

Each filter function will be called in the order they were added,
and will receive a `payload` object as the only argument,
containing the data about to be sent to the APM Server.

The format of the payload depends on the event type being sent.
For details about the different formats,
see the [events intake API docs](((apm-guide-ref))/api-events.html).

The filter function is synchronous and should return the manipulated payload object.
If a filter function doesn't return any value or returns a falsy value,
the remaining filter functions will not be called and the payload **will not** be sent to the APM Server.

Example usage:

```js
apm.addFilter(function redactSecretHeader(payload) {
  if (payload.context &&
      payload.context.request &&
      payload.context.request.headers &&
      payload.context.request.headers['x-secret']) {
    // redact sensitive data
    payload.context.request.headers['x-secret'] = '[REDACTED]'
  }

  // remember to return the modified payload
  return payload
})
```

A set of built-in filters are added by default.
See <DocLink id="serverlessObservabilityApmAgentsNodejsConfigure" section="filterhttpheaders">`filterHttpHeaders`</DocLink> for details.

Though you can also use filter functions to add new contextual information to the `user` and `custom` properties,
it's recommended that you use <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="apmsetusercontextcontext">`apm.setUserContext()`</DocLink> and <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="apmsetcustomcontextcontext">`apm.setCustomContext()`</DocLink> for that purpose.

<div id="apm-add-error-filter"></div>

### `apm.addErrorFilter(fn)`

_Added in: v2.0.0_

Similar to <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="apmaddfilterfn">`apm.addFilter()`</DocLink>,
but the `fn` will only be called with error payloads.

<div id="apm-add-transaction-filter"></div>

### `apm.addTransactionFilter(fn)`

_Added in: v2.0.0_

Similar to <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="apmaddfilterfn">`apm.addFilter()`</DocLink>,
but the `fn` will only be called with transaction payloads.

<div id="apm-add-span-filter"></div>

### `apm.addSpanFilter(fn)`

_Added in: v2.0.0_

Similar to <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="apmaddfilterfn">`apm.addFilter()`</DocLink>,
but the `fn` will only be called with span payloads.

<div id="apm-add-metadata-filter"></div>

### `apm.addMetadataFilter(fn)`

_Added in: v3.14.0_

Use `addMetadataFilter(fn)` to supply a filter function for the
[metadata object](((apm-guide-ref))/api-metadata.html#api-metadata-schema)
sent to the APM Server. This will allow you to manipulate the data being
sent, for instance to remove possibly sensitive information.

Each filter function will be called in the order they were added, and will
receive a `metadata` object as the only argument. The filter function is
synchronous and must return the manipulated object. Example usage:

```js
apm.addMetadataFilter(function dropArgv(metadata) {
  if (metadata.process && metadata.process.argv) {
    delete metadata.process.argv
  }
  return metadata
})
```

Warning: It is the responsibility of the author to ensure the returned object
conforms to the
[metadata schema](((apm-guide-ref))/api-metadata.html#api-metadata-schema)
otherwise all APM data injest will fail. A metadata filter that breaks the
metadata will result in error logging from the agent, something like:

```text
ERROR (elastic-apm-node): APM Server transport error (400): Unexpected APM Server response
APM Server accepted 0 events in the last request
Error: validation error: 'metadata' required
  Document: {"metadata":null}
```

<div id="apm-set-user-context"></div>

### `apm.setUserContext(context)`

_Added in: v0.1.0_

* `context` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object[<Object>]` Accepts the following optional properties:
    * `id` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` | `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type[<number>]` The user's ID.
    * `username` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` The user's username.
    * `email` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` The user's e-mail.

Call this to enrich collected performance data and errors with information about the user/client.
This function can be called at any point during the request/response life cycle (i.e. while a transaction is active).

The given `context` will be added to the active transaction.
If no active transaction can be found,
`false` is returned.
Otherwise `true`.

It's possible to call this function multiple times within the scope of the same active transaction.
For each call, the properties of the `context` argument are shallow merged with the context previously given.

If an error is captured,
the context from the active transaction is used as context for the captured error,
and any custom context given as the 2nd argument to <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="apmcaptureerrorerror[-options][-callback]">`apm.captureError`</DocLink> takes precedence and is shallow merged on top.

The provided user context is stored under `context.user` in Elasticsearch on both errors and transactions.

<div id="apm-set-custom-context"></div>

### `apm.setCustomContext(context)`

_Added in: v0.1.0_

* `context` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object[<Object>]` Can contain any property that can be JSON encoded.

Call this to enrich collected errors and transactions with any information that you think will help you debug performance issues or errors.
This function can be called at any point while a transaction is active (e.g. during the request/response life cycle of an incoming HTTP request).

The provided custom context is stored under `context.custom` in APM Server pre-7.0,
or `transaction.custom` and `error.custom` in APM Server 7.0+.

The given `context` will be added to the active transaction.
If no active transaction can be found,
`false` is returned.
Otherwise `true`.

It's possible to call this function multiple times within the scope of the same active transaction.
For each call, the properties of the `context` argument are shallow merged with the context previously given.

If an error is captured,
the context from the active transaction is used as context for the captured error,
and any custom context given as the 2nd argument to <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="apmcaptureerrorerror[-options][-callback]">`apm.captureError`</DocLink> takes precedence and is shallow merged on top.

<DocCallOut title="Tip">
Before using custom context, ensure you understand the different types of
[metadata](((apm-guide-ref))/data-model-metadata.html) that are available.
</DocCallOut>

<div id="apm-set-label"></div>

#### `apm.setLabel(name, value[, stringify ### true])`

_Added in: v0.1.0_
_Renamed from `apm.setTag()` to `apm.setLabel()`: v2.10.0_
_Added `stringify` argument in: v3.11.0_

* `name` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]`
    Any periods (`.`), asterisks (`*`), or double quotation marks (`"`) will be replaced by underscores (`_`),
    as those characters have special meaning in Elasticsearch

* `value` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` | `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type[<number>]` | `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type[<boolean>]`
* `stringify` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type[<boolean>]`
    Defaults to `true`. When true, if a non-string `value` is given, it is
    converted to a string before being sent to the APM Server.

Set a label on the current transaction.
You can set multiple labels on the same transaction.
If an error happens during the current transaction,
it will also get tagged with the same label.

<DocCallOut title="Tip">
Labels are key/value pairs that are indexed by Elasticsearch and therefore searchable
(as opposed to data set via <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="apmsetcustomcontextcontext">`apm.setCustomContext()`</DocLink>).
Before using custom labels, ensure you understand the different types of
[metadata](((apm-guide-ref))/data-model-metadata.html) that are available.
</DocCallOut>

<DocCallOut title="Warning" color="warning">
Avoid defining too many user-specified labels.
Defining too many unique fields in an index is a condition that can lead to a
[mapping explosion](((ref))/mapping.html#mapping-limit-settings).
</DocCallOut>

<div id="apm-add-labels"></div>

#### `apm.addLabels({ [name]: value }[, stringify ### true])`

_Added in: v1.5.0_
_Renamed from `apm.addTags()` to `apm.addLabels()`: v2.10.0_
_Added `stringify` argument in: v3.11.0_

* `labels` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object[<Object>]` Contains key/value pairs:
    * `name` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]`
        Any periods (`.`), asterisks (`*`), or double quotation marks (`"`) will be replaced by underscores (`_`),
        as those characters have special meaning in Elasticsearch

    * `value` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` | `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type[<number>]` | `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type[<boolean>]`
* `stringify` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type[<boolean>]`
    Defaults to `true`. When true, if a non-string `value` is given, it is
    converted to a string before being sent to the APM Server.

Add several labels on the current transaction.
You can add labels multiple times.
If an error happens during the current transaction,
it will also get tagged with the same labels.

<DocCallOut title="Tip">
Labels are key/value pairs that are indexed by Elasticsearch and therefore searchable
(as opposed to data set via <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="apmsetcustomcontextcontext">`apm.setCustomContext()`</DocLink>).
Before using custom labels, ensure you understand the different types of
[metadata](((apm-guide-ref))/data-model-metadata.html) that are available.
</DocCallOut>

<DocCallOut title="Warning" color="warning">
Avoid defining too many user-specified labels.
Defining too many unique fields in an index is a condition that can lead to a
[mapping explosion](((ref))/mapping.html#mapping-limit-settings).
</DocCallOut>

<div id="apm-set-global-label"></div>

### `apm.setGlobalLabel(name, value)`

_Added in: v3.47.0_

* `name` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]`
* `value` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` | `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type[<number>]` | `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type[<boolean>]`

Extends the <DocLink id="serverlessObservabilityApmAgentsNodejsConfigure" section="globallabels">`globalLabels`</DocLink> configuration. It allows setting labels that are applied to all transactions. A potential use case is to specify a label with the state of your application: `'initializing' | 'available' | 'unhealthy'`.

<DocCallOut title="Tip">
Labels are key/value pairs that are indexed by Elasticsearch and therefore searchable
(as opposed to data set via <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="apmsetcustomcontextcontext">`apm.setCustomContext()`</DocLink>).
Before using custom labels, ensure you understand the different types of
[metadata](((apm-guide-ref))/data-model-metadata.html) that are available.
</DocCallOut>

<DocCallOut title="Warning" color="warning">
Avoid defining too many user-specified labels.
Defining too many unique fields in an index is a condition that can lead to a
[mapping explosion](((ref))/mapping.html#mapping-limit-settings).
</DocCallOut>

<div id="apm-capture-error"></div>

### `apm.captureError(error[, options][, callback])`

_Added in: v0.1.0_

* `error` - Can be either an `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error[<Error>]` object,
    a <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="message-strings">message string</DocLink>,
    or a <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="parameterized-message-object">special parameterized message object</DocLink>

* `options` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object[<Object>]` The following options are supported:

    * `timestamp` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type[<number>]` The time when the error happened.
        Must be a Unix Time Stamp representing the number of milliseconds since January 1, 1970, 00:00:00 UTC.
        Sub-millisecond precision can be achieved using decimals.
        If not provided,
        the current time will be used

    * `message` - If the `error` argument is an `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error[<Error>]` object,
        it's possible to use this option to supply an additional message string that will be stored along with the error message under `log.message`

    * `user` - See <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="metadata">metadata section</DocLink> for details about this option

    * `custom` - See <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="metadata">metadata section</DocLink> for details about this option

    * `request` `https://nodejs.org/api/http.html#http_class_http_incomingmessage[<http.IncomingMessage>]` You can associate an error with information about the incoming request to gain additional context such as the request url, headers, and cookies.
        However, in most cases, the agent will detect if an error was in response to an http request and automatically add the request details for you.
        See <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="http-requests">http requests section</DocLink> for more details.

    * `response` `https://nodejs.org/api/http.html#http_class_http_serverresponse[<http.ServerResponse>]` You can associate an error with information about the http response to get additional details such as status code and headers.
        However, in most cases, the agent will detect if an error occured during an http request and automatically add response details for you.
        See <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="http-responses">http responses section</DocLink> for more details.

    * `handled` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type[<boolean>]` Adds additional context to the exception to show
        whether the error is handled or uncaught. Unhandled errors are immediately
        flushed to APM server, in case the application is about the crash.
        **Default:** `true`.

    * `labels` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object[<Object>]` Add additional context with labels, these labels will be added to the error along with the labels from the current transaction.
        See the <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="apmaddlabels{-[name]-value-}[-stringify-=-true]">`apm.addLabels()`</DocLink> method for details about the format.

    * `captureAttributes` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type[<boolean>]` Whether to include properties on the given `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error[<Error>]` object in the data sent to the APM Server (as `error.exception.attributes`). **Default:** `true`.

    * `skipOutcome` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type[<boolean>]` Whether to skip setting the outcome value for the current span to `failure`.  See <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="spanoutcome">Span outcome</DocLink> for more information. **Default:** `false`.

    * `parent` <DocLink id="serverlessObservabilityApmAgentsNodejsApi">Transaction</DocLink> | <DocLink id="serverlessObservabilityApmAgentsNodejsApi">Span</DocLink> | `null` - A Transaction or Span instance to make the parent of this error. If not given (or `undefined`), then the current span or transaction will be used. If `null` is given, then no span or transaction will be used. _(Added in v3.33.0.)_

* `callback` - Will be called after the error has been sent to the APM Server.
    It will receive an `Error` instance if the agent failed to send the error,
    and the id of the captured error.

Send an error to the APM Server:

```js
apm.captureError(new Error('boom!'))
```

<div id="message-strings"></div>

#### Message strings

Instead of an `Error` object,
you can log a plain text message:

```js
apm.captureError('Something happened!')
```

This will also be sent as an error to the APM Server,
but will not be associated with an exception.

<div id="parameterized-message-object"></div>

#### Parameterized message object

Instead of an `Error` object or a string,
you can supply a special parameterized message object:

```js
apm.captureError({
  message: 'Could not find user %s with id %d in the database',
  params: ['Peter', 42]
})
```

This makes it possible to better group error messages that contain variable data like ID's or names.

<div id="metadata"></div>

#### Metadata

To ease debugging it's possible to send some extra data with each error you send to the APM Server.
The APM Server intake API supports a lot of different metadata fields,
most of which are automatically managed by the Elastic APM Node.js Agent.
But if you wish you can supply some extra details using `user` or `custom`.
For more details on the properties accepted by the events intake API see the [events intake API docs](((apm-guide-ref))/api-events.html).

To supply any of these extra fields,
use the optional options argument when calling `apm.captureError()`.

Here are some examples:

```js
// Sending some extra details about the user
apm.captureError(error, {
  user: {
    id: 'unique_id',
    username: 'foo',
    email: 'foo@example.com'
  }
})

// Sending some arbitrary details using the `custom` field
apm.captureError(error, {
  custom: {
    some_important_metric: 'foobar'
  }
})
```

To supply per-request metadata to all errors captured in one central location,
use <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="apmsetusercontextcontext">`apm.setUserContext()`</DocLink> and <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="apmsetcustomcontextcontext">`apm.setCustomContext()`</DocLink>.

<div id="http-requests"></div>

#### HTTP requests

Besides the options described in the <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="metadata">metadata section</DocLink>,
you can use the `options` argument to associate the error with an HTTP request:

```js
apm.captureError(err, {
  request: req // an instance of http.IncomingMessage
})
```

This will log the URL that was requested,
the HTTP headers,
cookies and other useful details to help you debug the error.

In most cases, this isn't needed,
as the agent is pretty smart at figuring out if your Node.js app is an HTTP server and if an error occurred during an incoming request.
In which case it will automate this processes for you.

<div id="http-responses"></div>

#### HTTP responses

Besides the options described in the <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="metadata">metadata section</DocLink>,
you can use the `options` argument to associate the error with an HTTP response:

```js
apm.captureError(err, {
  response: res // an instance of http.ServerResponse
})
```

This will log the response status code,
headers and other useful details to help you debug the error.

In most cases, this isn't needed,
as the agent is pretty smart at figuring out if your Node.js app is an HTTP server and if an error occurred during an incoming request.
In which case it will automate this processes for you.

<div id="apm-middleware-connect"></div>

### `apm.middleware.connect()`

_Added in: v0.1.0_

Returns a middleware function used to collect and send errors to the APM Server.

```js
const apm = require('elastic-apm-node').start()
const connect = require('connect')

const app = connect()

// your regular middleware:
app.use(...)
app.use(...)

// your main HTTP router
app.use(function (req, res, next) {
  throw new Error('Broke!')
})

// add Elastic APM in the bottom of the middleware stack
app.use(apm.middleware.connect())

app.listen(3000)
```

<DocCallOut title="Note">
`apm.middleware.connect` _must_ be added to the middleware stack _before_ any other error handling middleware functions or there's a chance that the error will never get to the agent.
</DocCallOut>

<div id="apm-start-transaction"></div>

### `apm.startTransaction([name][, type][, subtype][, action][, options])`

_Added in: v0.1.0_
_Transaction `subtype` and `action` deprecated in: v3.25.0_

* `name` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` The name of the transaction.
    You can always set this later via <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="transactionname">`transaction.name`</DocLink> or <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="apmsettransactionnamename">`apm.setTransactionName()`</DocLink>.
    **Default:** `unnamed`

* `type` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` The type of the transaction.
    You can always set this later via <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="transactiontype">`transaction.type`</DocLink>.

* `subtype` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` The subtype of the transaction.
    You can alternatively set this via <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="transactionsubtype-deprecated[v3250]">`transaction.subtype`</DocLink>.
    The transaction `subtype` field is deprecated: it is not used and will be
    removed in the next major version.

* `action` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` The action of the transaction.
    You can alternatively set this via <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="transactionaction-deprecated[v3250]">`transaction.action`</DocLink>.
    The transaction `action` field is deprecated: it is not used and will be removed
    in the next major version.

* `options` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object[<Object>]` The following options are supported:

    * `startTime` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type[<number>]` The time when the transaction started.
        Must be a Unix Time Stamp representing the number of milliseconds since January 1, 1970, 00:00:00 UTC.
        Sub-millisecond precision can be achieved using decimals.
        If not provided,
        the current time will be used

    * `childOf` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` A W3C trace-context "traceparent" string, typically received from a remote service call.

    * `tracestate` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` A W3C trace-context "tracestate" string.

    * `links` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array[<Array>]` Span links.
        A transaction can refer to zero or more other transactions or spans (separate
        from its parent). Span links will be shown in the Kibana APM app trace view.
        The `links` argument is an array of objects with a single "context" field
        that is a `Transaction`, `Span`, or W3C trace-context 'traceparent' string.
        For example: `apm.startTransaction('aName', { links: [{ context: anotherSpan }] })`.

Start a new transaction.

Use this function to create a custom transaction.
Note that the agent will do this for you automatically whenever your application receives an incoming HTTP request.
You only need to use this function to create custom transactions.

There's a special `type` called `request` which is used by the agent for the transactions automatically created when an incoming HTTP request is detected.

See the <DocLink id="serverlessObservabilityApmAgentsNodejsApi">Transaction API</DocLink> docs for details on how to use custom transactions.

<div id="apm-end-transaction"></div>

### `apm.endTransaction([result][, endTime])`

_Added in: v0.1.0_

* `result` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` Describes the result of the transaction.
    This is typically the HTTP status code,
    or e.g. "success" or "failure" for a background task

* `endTime` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type[<number>]` The time when the transaction ended.
    Must be a Unix Time Stamp representing the number of milliseconds since January 1, 1970, 00:00:00 UTC.
    Sub-millisecond precision can be achieved using decimals.
    If not provided,
    the current time will be used

Ends the active transaction.
If no transaction is currently active,
nothing happens.

Note that the agent will do this for you automatically for all regular HTTP transactions.
You only need to use this function to end custom transactions created by <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="apmstarttransaction[name][-type][-subtype][-action][-options]">`apm.startTransaction()`</DocLink> or if you wish the end a regular transaction prematurely.

Alternatively you can call <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="transactionend[result][-endtime]">`end()`</DocLink> directly on an active transaction object.

<div id="apm-current-transaction"></div>

### `apm.currentTransaction`

_Added in: v1.9.0_

Get the currently active transaction,
if used within the context of a transaction.

<DocCallOut title="Note">
If there's no active transaction available,
`null` will be returned.
</DocCallOut>

<div id="apm-current-span"></div>

### `apm.currentSpan`

_Added in: v2.0.0_

Get the currently active span,
if used within the context of a span.

<DocCallOut title="Note">
If there's no active span available,
`null` will be returned.
</DocCallOut>

<div id="apm-current-traceparent"></div>

### `apm.currentTraceparent`

_Added in: v2.9.0_

Get the serialized traceparent string of the current transaction or span.

<DocCallOut title="Note">
If there's no active transaction or span available,
`null` will be returned.
</DocCallOut>

<div id="apm-set-transaction-name"></div>

### `apm.setTransactionName(name)`

_Added in: v0.1.0_

* `name` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` Set or overwrite the name of the current transaction.

If you use a supported router/framework the agent will automatically set the transaction name for you.

If you do not use Express, hapi, koa-router, Restify, or Fastify or if the agent for some reason cannot detect the name of the HTTP route,
the transaction name will default to `METHOD unknown route` (e.g. `POST unknown route`).

Read more about naming routes manually in the <DocLink id="serverlessObservabilityApmAgentsNodejsGetStarted" section="route-naming">Get started with a custom Node.js stack</DocLink> article.

<div id="apm-start-span"></div>

### `apm.startSpan([name][, type][, subtype][, action][, options])`

_Added in: v1.1.0_

* `name` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` The name of the span.
    You can alternatively set this via <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="spanname">`span.name`</DocLink>.
    **Default:** `unnamed`

* `type` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` The type of the span.
    You can alternatively set this via <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="spantype">`span.type`</DocLink>.

* `subtype` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` The subtype of the span.
    You can alternatively set this via <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="spansubtype">`span.subtype`</DocLink>.

* `action` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` The action of the span.
    You can alternatively set this via <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="spanaction">`span.action`</DocLink>.

* `options` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object[<Object>]` The following options are supported:

    * `startTime` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type[<number>]` The time when the span started.
        Must be a Unix Time Stamp representing the number of milliseconds since January 1, 1970, 00:00:00 UTC.
        Sub-millisecond precision can be achieved using decimals.
        If not provided,
        the current time will be used

    * `exitSpan` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type[<boolean>]` Make an "exit span".
        Exit spans represent outgoing communication. They are used to create a node
        in the [Service Map](((kibana-ref))/service-maps.html) and a downstream service
        in the [Dependencies Table](((kibana-ref))/dependencies.html). The provided subtype
        will be used as the downstream service name.

    * `links` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array[<Array>]` Span links.
        A span can refer to zero or more other transactions or spans (separate from
        its parent). Span links will be shown in the Kibana APM app trace view. The
        `links` argument is an array of objects with a single "context" field that is a
        `Transaction`, `Span`, or W3C trace-context 'traceparent' string.  For example:
        `apm.startSpan('aName', { links: [{ context: anotherSpan }] })`.

Start and return a new custom span associated with the current active transaction.
This is the same as getting the current transaction with `apm.currentTransaction` and,
if a transaction was found,
calling `transaction.startSpan(name, type, options)` on it.

When a span is started it will measure the time until <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="spanend[endtime]">`span.end()`</DocLink> is called.

See <DocLink id="serverlessObservabilityApmAgentsNodejsApi">Span API</DocLink> docs for details on how to use custom spans.

<DocCallOut title="Note">
If there's no active transaction available,
`null` will be returned.
</DocCallOut>

<div id="apm-handle-uncaught-exceptions"></div>

### `apm.handleUncaughtExceptions([callback])`

_Added in: v0.1.0_

By default, the agent will terminate the Node.js process when an uncaught exception is detected.
Use this function if you need to run any custom code before the process is terminated.

```js
apm.handleUncaughtExceptions(function (err) {
  // Do your own stuff... and then exit:
  process.exit(1)
})
```

The callback is called **after** the event has been sent to the APM Server with the following arguments:

* `err` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error[<Error>]` the captured exception

This function will also enable the uncaught exception handler if it was disabled using the <DocLink id="serverlessObservabilityApmAgentsNodejsConfigure" section="captureexceptions">`captureExceptions`</DocLink> configuration option.

If you don't specify a callback,
the node process is terminated automatically when an uncaught exception has been captured and sent to the APM Server.

[It is recommended](https://nodejs.org/api/process.html#process_event_uncaughtexception) that you don't leave the process running after receiving an uncaught exception,
so if you are using the optional callback,
remember to terminate the node process.

<div id="apm-flush"></div>

### `apm.flush([callback])`

_Added in: v0.12.0_

```js
// with node-style callback
apm.flush(function (err) {
  // Flush complete
})

// with promises
apm.flush().then(function () {
  // Flush complete
}).catch(function (err) {
  // Flush returned an error
})

// inside of an async function
try {
  await apm.flush()
  // Flush complete
} catch (err) {
  // Flush returned an error
}
```

Manually end the active outgoing HTTP request to the APM Server.
The HTTP request is otherwise ended automatically at regular intervals,
controlled by the <DocLink id="serverlessObservabilityApmAgentsNodejsConfigure" section="apirequesttime">`apiRequestTime`</DocLink> and <DocLink id="serverlessObservabilityApmAgentsNodejsConfigure" section="apirequestsize">`apiRequestSize`</DocLink> config options.

If an optional `callback` is provided as the first argument to this method, it will call `callback(flushErr)` when complete. 
If no `callback` is provided, then a `Promise` will be returned, which will either resolve with `void` or reject with `flushErr`.

The callback is called (or the `Promise` resolves if no `callback` argument is provided) **after** the active HTTP request has ended.
The callback is called even if no HTTP request is currently active.

<div id="apm-lambda"></div>

### `apm.lambda([type, ]handler)`

_Added in: v1.4.0_

```js
exports.hello = apm.lambda(function (event, context, callback) {
  callback(null, `Hello, ${payload.name}!`)
})
```

Manually instrument an AWS Lambda function to form a transaction around each execution.
Optionally, a type may also be provided to group lambdas together. By default,
"lambda" will be used as the type name.

Read more lambda support in the <DocLink id="serverlessObservabilityApmAgentsNodejsGetStarted">Lambda</DocLink> article.

<div id="apm-add-patch"></div>

### `apm.addPatch(modules, handler)`

_Added in: v2.7.0_

* `modules` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` | `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string[\]>]`
    Name of module(s) to apply the patch to, when required.

* `handler` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function[<Function>]` | `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]`
    Must be a patch function or a path to a module exporting a patch function

    * `exports` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object[<Object>]` The original export object of the module
    * `agent` - The agent instance to use in the patch function
    * `options` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object[<Object>]` The following options are supported:
        * `version` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` | `https://developer.mozilla.org/en-US/docs/Glossary/Undefined[<undefined>]` The module version, if applicable.
        * `enabled` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type[<boolean>]` A flag indicating if the instrumentation is enabled.
            Any module patch can be disabled, by module name, with <DocLink id="serverlessObservabilityApmAgentsNodejsConfigure" section="disableinstrumentations">`disableInstrumentations`</DocLink>.

Register a module patch to apply on intercepted `require` calls.

A module can have any number of patches and will be applied in the order they are added.

```js
apm.addPatch('timers', (exports, agent, { version, enabled }) => {
  const setTimeout = exports.setTimeout
  exports.setTimeout = (fn, ms) => {
    const span = agent.startSpan('set-timeout')
    return setTimeout(() => {
      span.end()
      fn()
    }, ms)
  }

  return exports
})

// or ...

apm.addPatch(['hapi', '@hapi/hapi'], (exports, agent, { version, enabled }) => {
  const setTimeout = exports.setTimeout
  exports.setTimeout = (fn, ms) => {
    const span = agent.startSpan('set-timeout')
    return setTimeout(() => {
      span.end()
      fn()
    }, ms)
  }

  return exports
})

// or ...

apm.addPatch('timers', './timer-patch')
```

<div id="apm-remove-patch"></div>

### `apm.removePatch(modules, handler)`

_Added in: v2.7.0_

Removes a module patch.
This will generally only be needed when replacing an existing patch.
To _disable_ instrumentation while keeping context propagation support, see <DocLink id="serverlessObservabilityApmAgentsNodejsConfigure" section="disableinstrumentations">`disableInstrumentations`</DocLink>.

```js
apm.removePatch('timers', './timers-patch')

// or ...

apm.removePatch(['timers'], './timers-patch')

// or ...

apm.removePatch('timers', timerPatchFunction)
```

<div id="apm-clear-patches"></div>

### `apm.clearPatches(modules)`

_Added in: v2.7.0_

Clear all patches for the given module.
This will generally only be needed when replacing an existing patch.
To _disable_ instrumentation while keeping context propagation support, see <DocLink id="serverlessObservabilityApmAgentsNodejsConfigure" section="disableinstrumentations">`disableInstrumentations`</DocLink>.

```js
apm.clearPatches('timers')

// or ...

apm.clearPatches(['timers'])
```

<div id="apm-current-trace-ids"></div>

### `apm.currentTraceIds`

_Added in: v2.17.0_

`apm.currentTraceIds` produces an object containing `trace.id` and either `transaction.id` or `span.id` when a current transaction or span is available.
When no transaction or span is available it will return an empty object.
This enables <DocBadge><DocIcon size="s" type="unlink" title="missing link"/> missing link</DocBadge>{/*  <DocLink id="enApmAgentNodejsLogs" section="log-correlation">log correlation</DocLink> */} to APM traces with structured loggers.

```js
{
  "trace.id": "abc123",
  "transaction.id": "abc123"
}
// or ...
{
  "trace.id": "abc123",
  "span.id": "abc123"
}
```

<div id="apm-register-custom-metrics"></div>

### `apm.registerMetric(name[, labels], callback)`

<DocCallOut template="technical_preview" />
* `name` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]`
    Name of the metrics.

* `labels` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object[<Object>]` Contains key/value pairs.
    Optional labels. Omittable.

* `callback` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function[<Function>]`
    Must be a function that returns the current metric value.

Register a metric callback.

Take care not to use the names of <DocBadge><DocIcon size="s" type="unlink" title="missing link"/> missing link</DocBadge>{/*  <DocLink id="enApmAgentNodejsMetrics">built-in metrics</DocLink> */}.

```js
apm.registerMetric( 'ws.connections' , () => {
  return wss.clients.size;
})

// or, to additionally label the metric with "module: 'ws'":

apm.registerMetric( 'ws.connections' , {module : 'ws'}, () => {
  return wss.clients.size;
})

```

<div id="apm-transaction-outcome"></div>

### `apm.setTransactionOutcome(outcome)`

_Added in: v3.12.0_

* `outcome` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]`

Will set the outcome property on the _current_ transaction.

See the <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="transactionoutcome">Transaction Outcome docs</DocLink> for more information.

<div id="apm-span-outcome"></div>

### `apm.setSpanOutcome(outcome)`

_Added in: v3.12.0_

* `outcome` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]`

Will set the outcome property on the _current_ span.

See the <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="spanoutcome">Span Outcome docs</DocLink> for more information.
