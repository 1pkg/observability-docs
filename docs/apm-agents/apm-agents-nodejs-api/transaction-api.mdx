

import EnsureParentIdSnippet from '../../transclusion/transaction-api/ensure-parent-id-snippet.mdx'

<div id="transaction-api"></div>

export let env_github = false

<DocIf condition={ env_github === true }>

<DocCallOut title="Note">
For the best reading experience,
please view this documentation at [elastic.co](https://www.elastic.co/guide/en/apm/agent/nodejs/current/transaction-api.html)
</DocCallOut>

</DocIf>

A transaction groups multiple spans in a logical group.

To get a `Transaction` object,
you need to call <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="apmstarttransaction[name][-type][-subtype][-action][-options]">`apm.startTransaction()`</DocLink>.

To see an example of using custom transactions,
see the <DocLink id="serverlessObservabilityApmAgentsNodejsConfigure">Custom Transactions in Node.js</DocLink> article.

<div id="transaction-name"></div>

### `transaction.name`

_Added in: v0.1.0_

* `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` **Default:** `unnamed`

The name of the transaction.

Can be used to set or overwrite the name of the transaction (visible in the performance monitoring breakdown).
If you don't have access to the current transaction,
you can also set the name using <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="apmsettransactionnamename">`apm.setTransactionName()`</DocLink>.

Transactions with the same name and <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="transactiontype">type</DocLink> are grouped together.

<div id="transaction-type"></div>

### `transaction.type`

_Added in: v0.1.0_

_Split components into `type`, `subtype` and `action` in: v3.0.0_

* `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` **Default:** `custom`

The type of the transaction.

There's a special type called `request` which is used by the agent for the transactions automatically created when an incoming HTTP request is detected.

<div id="transaction-subtype"></div>

### `transaction.subtype` <DocBadgeDeprecated tipContent="Deprecated in v3.25.0">v3.25.0</DocBadgeDeprecated>

_Added in: v3.0.0_
_Deprecated in: v3.25.0_

* `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` **Default:** `custom`

The subtype of the transaction.
The transaction `subtype` field is deprecated: it is not used and will be
removed in the next major version.

<div id="transaction-action"></div>

### `transaction.action` <DocBadgeDeprecated tipContent="Deprecated in v3.25.0">v3.25.0</DocBadgeDeprecated>

_Added in: v3.0.0_
_Deprecated in: v3.25.0_

* `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` **Default:** `custom`

The action of the transaction.
The transaction `action` field is deprecated: it is not used and will be removed
in the next major version.

<div id="transaction-traceparent"></div>

### `transaction.traceparent`

_Added in: v2.9.0_

Get the serialized traceparent string of the transaction.

<div id="transaction-result"></div>

### `transaction.result`

_Added in: v0.1.0_

* `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` **Default:** `success`

A string describing the result of the transaction.
This is typically the HTTP status code,
or e.g. "success" or "failure" for a background task.

<div id="transaction-start-span"></div>

### `transaction.startSpan([name][, type][, subtype][, action][, options])`

_Added in: v2.0.0_

_Split `type` into `type`, `subtype` and `action` in: v3.0.0_

* `name` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` The name of the span.
    You can alternatively set this via <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="spanname">`span.name`</DocLink>.
    **Default:** `unnamed`

* `type` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` The type of the span.
    You can alternatively set this via <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="spantype">`span.type`</DocLink>.

* `subtype` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` The subtype of the span.
    You can alternatively set this via <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="spansubtype">`span.subtype`</DocLink>.

* `action` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` The action of the span.
    You can alternatively set this via <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="spanaction">`span.action`</DocLink>.

* `options` - The following options are supported:

    * `startTime` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type[<number>]` The time when the span started.
        Must be a Unix Time Stamp representing the number of milliseconds since January 1, 1970, 00:00:00 UTC.
        Sub-millisecond precision can be achieved using decimals.
        If not provided,
        the current time will be used

    * `exitSpan` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type[<boolean>]` Make an "exit span".
        Exit spans represent outgoing communication. They are used to create a node
        in the [Service Map](((kibana-ref))/service-maps.html) and a downstream service
        in the [Dependencies Table](((kibana-ref))/dependencies.html). The provided subtype
        will be used as the downstream service name.

    * `links` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array[<Array>]` Span links.
        A span can refer to zero or more other transactions or spans (separate from
        its parent). Span links will be shown in the Kibana APM app trace view. The
        `links` argument is an array of objects with a single "context" field that is a
        `Transaction`, `Span`, or W3C trace-context 'traceparent' string.  For example:
        `transaction.startSpan('aName', { links: [{ context: anotherSpan }] })`.

Start and return a new custom span associated with this transaction.
When a span is started it will measure the time until <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="spanend[endtime]">`span.end()`</DocLink> is called.

See <DocLink id="serverlessObservabilityApmAgentsNodejsApi">Span API</DocLink> docs for details on how to use custom spans.

<div id="transaction-set-label"></div>

#### `transaction.setLabel(name, value[, stringify ### true])`

_Added in: v0.1.0_
_Renamed from `transaction.setTag()` to `transaction.setLabel()`: v2.10.0_
_Added `stringify` argument in: v3.11.0_

* `name` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]`
    Any periods (`.`), asterisks (`*`), or double quotation marks (`"`) will be replaced by underscores (`_`),
    as those characters have special meaning in Elasticsearch

* `value` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` | `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type[<number>]` | `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type[<boolean>]`
* `stringify` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type[<boolean>]`
    Defaults to `true`. When true, if a non-string `value` is given, it is
    converted to a string before being sent to the APM Server

Set a label on the transaction.
You can set multiple labels on the same transaction.
If an error happens during the transaction,
it will also get tagged with the same labels.

Tags are key/value pairs that are indexed by Elasticsearch and therefore searchable (as opposed to data set via <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="apmsetcustomcontextcontext">`apm.setCustomContext()`</DocLink>).

<div id="transaction-add-labels"></div>

#### `transaction.addLabels({ [name]: value }[, stringify ### true])`

_Added in: v1.5.0_
_Renamed from `transaction.addTags()` to `transaction.addLabels()`: v2.10.0_
_Added `stringify` argument in: v3.11.0_

* `labels` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object[<Object>]` Contains key/value pairs:
    * `name` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]`
        Any periods (`.`), asterisks (`*`), or double quotation marks (`"`) will be replaced by underscores (`_`),
        as those characters have special meaning in Elasticsearch

    * `value` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` | `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type[<number>]` | `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type[<boolean>]`
* `stringify` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type[<boolean>]`
    Defaults to `true`. When true, if a non-string `value` is given, it is
    converted to a string before being sent to the APM Server.

Add several labels on the transaction.
You can add labels multiple times.
If an error happens during the transaction,
it will also get tagged with the same labels.

Labels are key/value pairs that are indexed by Elasticsearch and therefore searchable (as opposed to data set via <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="apmsetcustomcontextcontext">`apm.setCustomContext()`</DocLink>).

<div id="transaction-ensure-parent-id"></div>

### `transaction.ensureParentId()`

_Added in: v2.0.0_

* `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]`

If the transaction does not already have a parent id,
calling this method generates a new parent id,
sets it as the parent id of this transaction,
and returns it as a `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]`.

This enables the correlation of the spans the JavaScript Real User Monitoring (RUM) agent creates for the initial page load with the transaction of the backend service.
If your backend service generates the HTML page dynamically,
initializing the JavaScript RUM agent with the value of this method allows analyzing the time spent in the browser vs in the backend services.

{/* WARNING: The below content is reused in distributed-tracing.asciidoc */}
{/* Ensure any changes made here are safe to include on that page as well. */}
<EnsureParentIdSnippet />

See the [JavaScript RUM agent documentation](((apm-rum-ref))) for more information.

<div id="transaction-ids"></div>

### `transaction.ids`

_Added in: v2.17.0_

Produces an object containing `transaction.id` and `trace.id`.
This enables log correlation to APM traces with structured loggers.

```js
{
  "trace.id": "abc123",
  "transaction.id": "abc123"
}
```

<div id="transaction-to-string"></div>

### `transaction.toString()` <DocBadgeDeprecated tipContent="Deprecated in v3.23.0">v3.23.0</DocBadgeDeprecated>

_Added in: v2.17.0_
_Deprecated in: v3.23.0_

Produces a string representation of the transaction to inject in log messages.
This enables log correlation to APM traces with text-only loggers.

```js
"trace.id=abc123 transaction.id=abc123"
```

Relying on the format of `transaction.toString()` has been **deprecated** and may
change in v4 of the agent. Prefer the use of <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="transactionids">`transaction.ids`</DocLink> or
<DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="apmcurrenttraceids">`apm.currentTraceIds`</DocLink>. The v3 format may be reproduced
via:

```js
const { stringify } = require('querystring')
console.log( stringify(transaction.ids, ' ', '=')) )
```

<div id="transaction-end"></div>

### `transaction.end([result][, endTime])`

_Added in: v0.1.0_

* `result` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]` Describes the result of the transaction.
    This is typically the HTTP status code,
    or e.g. "success" or "failure" for a background task

* `endTime` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type[<number>]` The time when the transaction ended.
    Must be a Unix Time Stamp representing the number of milliseconds since January 1, 1970, 00:00:00 UTC.
    Sub-millisecond precision can be achieved using decimals.
    If not provided,
    the current time will be used

Ends the transaction.
If the transaction has already ended,
nothing happens.

Alternatively you can call <DocLink id="serverlessObservabilityApmAgentsNodejsApi" section="apmendtransaction[result][-endtime]">`apm.endTransaction()`</DocLink> to end the active transaction.

<div id="transaction-outcome"></div>

### `transaction.outcome`

_Added in: v3.12.0_

The Node.js agent automatically sets an `outcome` property on transactions.  This property will be one of three values:

- `success`: Indicates the transaction's operation was a success.

- `failure`: Indicates the transaction's operation was _not_ a success.

- `unknown`: Indicates we were unable to determine if the transaction's operation was a success or not.  An `unknown` outcome removes a transaction from error rate considerations.

A transaction is considered a success if the underlying HTTP request handling produces a response with a status code that is less than `500`.  A status code of `500` or greater is considered a failure.

Non-HTTP transactions will begin with an outcome of `unknown`.

<div id="transaction-setoutcome"></div>

### `transaction.setOutcome(outcome)`

_Added in: v3.12.0_

* `outcome` `https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type[<string>]`

The `setOutcome` method allows an end user to override the Node.js agent's default setting of a transaction's `outcome` property.  The `setOutcome` method accepts a string of either `success`, `failure`, or `unknown`, and will force the agent to report this value for a specific span.
