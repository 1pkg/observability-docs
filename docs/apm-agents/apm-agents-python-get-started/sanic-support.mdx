

<div id="sanic-support"></div>

Incorporating Elastic APM into your Sanic project only requires a few easy
steps.

<div id="sanic-installation"></div>

### Installation

Install the Elastic APM agent using pip:

```bash
$ pip install elastic-apm
```

or add `elastic-apm` to your project's `requirements.txt` file.

<div id="sanic-setup"></div>

### Setup

To set up the agent, you need to initialize it with appropriate settings.

The settings are configured either via environment variables, or as
initialization arguments.

You can find a list of all available settings in the
<DocLink id="serverlessObservabilityApmAgentsPythonConfigure">Configuration</DocLink> page.

To initialize the agent for your application using environment variables:

```python
from sanic import Sanic
from elasticapm.contrib.sanic import ElasticAPM

app = Sanic(name="elastic-apm-sample")
apm = ElasticAPM(app=app)
```

To configure the agent using initialization arguments and Sanic's Configuration infrastructure:

```python
## Create a file named external_config.py in your application
## If you want this module based configuration to be used for APM, prefix them with ELASTIC_APM_
ELASTIC_APM_SERVER_URL = "https://serverurl.apm.com:443"
ELASTIC_APM_SECRET_TOKEN = "sometoken"
```

```python
from sanic import Sanic
from elasticapm.contrib.sanic import ElasticAPM

app = Sanic(name="elastic-apm-sample")
app.config.update_config("path/to/external_config.py")
apm = ElasticAPM(app=app)
```

<div id="sanic-usage"></div>

### Usage

Once you have configured the agent, it will automatically track transactions
and capture uncaught exceptions within sanic.

Capture an arbitrary exception by calling
<DocLink id="serverlessObservabilityApmAgentsPythonApi" section="clientcapture_exception">`capture_exception`</DocLink>:

```python
from sanic import Sanic
from elasticapm.contrib.sanic import ElasticAPM

app = Sanic(name="elastic-apm-sample")
apm = ElasticAPM(app=app)

try:
    1 / 0
except ZeroDivisionError:
    apm.capture_exception()
```

Log a generic message with <DocLink id="serverlessObservabilityApmAgentsPythonApi" section="clientcapture_message">`capture_message`</DocLink>:

```python
from sanic import Sanic
from elasticapm.contrib.sanic import ElasticAPM

app = Sanic(name="elastic-apm-sample")
apm = ElasticAPM(app=app)

apm.capture_message('hello, world!')
```

<div id="sanic-performance-metrics"></div>

### Performance metrics

If you've followed the instructions above, the agent has installed our
instrumentation middleware which will process all requests through your app.
This will measure response times, as well as detailed performance data for
all supported technologies.

<DocCallOut title="Note">
Due to the fact that `asyncio` drivers are usually separate from their
synchronous counterparts, specific instrumentation is needed for all drivers.
The support for asynchronous drivers is currently quite limited.
</DocCallOut>

<div id="sanic-ignoring-specific-views"></div>

#### Ignoring specific routes

You can use the
<DocLink id="serverlessObservabilityApmAgentsPythonConfigure" section="transactions_ignore_patterns">`TRANSACTIONS_IGNORE_PATTERNS`</DocLink>
configuration option to ignore specific routes. The list given should be a
list of regular expressions which are matched against the transaction name:

```python
from sanic import Sanic
from elasticapm.contrib.sanic import ElasticAPM

app = Sanic(name="elastic-apm-sample")
apm = ElasticAPM(app=app, config={
    'TRANSACTIONS_IGNORE_PATTERNS': ['^GET /secret', '/extra_secret'],
})
```

This would ignore any requests using the `GET /secret` route
and any requests containing `/extra_secret`.

<div id="extended-sanic-usage"></div>

### Extended Sanic APM Client Usage

Sanic's contributed APM client also provides a few extendable way to configure selective behaviors to enhance the
information collected as part of the transactions being tracked by the APM.

In order to enable this behavior, the APM Client middleware provides a few callback functions that you can leverage
in order to simplify the process of generating additional contexts into the traces being collected.
{/* [cols="1,1,1,1"] */}
|  |  |  |  |
|---|---|---|---|
| Callback Name | Callback Invocation Format | Expected Return Format | Is Async |
| transaction_name_callback | transaction_name_callback(request) | string | false |
| user_context_callback | user_context_callback(request) | (username_string, user_email_string, userid_string) | true |
| custom_context_callback | custom_context_callback(request) or custom_context_callback(response) | dict(str=str) | true |
| label_info_callback | label_info_callback() | dict(str=str) | true |

<div id="supported-stanic-and-python-versions"></div>

### Supported Sanic and Python versions

A list of supported <DocLink id="serverlessObservabilityApmAgentsPythonSupportedTechnologies" section="sanic">Sanic</DocLink> and
<DocLink id="serverlessObservabilityApmAgentsPythonSupportedTechnologies" section="python">Python</DocLink> versions can be found on our
<DocLink id="serverlessObservabilityApmAgentsPythonSupportedTechnologies">Supported Technologies</DocLink> page.

<DocCallOut title="Note">
Elastic APM only supports `asyncio` when using Python 3.7+
</DocCallOut>

