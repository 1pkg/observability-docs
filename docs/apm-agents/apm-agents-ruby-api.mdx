---
id: serverlessObservabilityApmAgentsRubyApi
slug: /serverless/observability/apm-agents-ruby-api
title: API
# description: Description to be written
tags: [ 'serverless', 'observability', '' ]
status: rough content
---

import RoughContent from '../partials/rough-content-notice.mdx'

<RoughContent />


export let env_github = false

<DocIf condition={ env_github === true }>
<DocCallOut title="Note">
For the best reading experience,
please view this documentation at
[elastic.co](https://www.elastic.co/guide/en/apm/agent/ruby/current/introduction.html)
</DocCallOut>
</DocIf>

<div id="api"></div>

Although most usage is covered automatically, Elastic APM also has a public
API that allows custom usage.

<div id="agent-life-cycle"></div>

## Agent life cycle

Controlling when the agent starts and stops.

<div id="api-agent-start"></div>

### `ElasticAPM.start`

To create and start an ElasticAPM agent use `ElasticAPM.start`:

```ruby
ElasticAPM.start(server_url: 'http://localhost:8200')
```

  * `config`: An optional hash or `ElasticAPM::Config` instance with configuration
      options.  See <DocLink id="serverlessObservabilityApmAgentsRubyConfigure">Configuration</DocLink>.

If you are using <DocLink id="serverlessObservabilityApmAgentsRubyGetStarted">Ruby on Rails</DocLink> this is done automatically for you.
If you choose not to require the `elastic_apm` gem and instead want to start the
agent and hook into Rails manually, see <DocLink id="serverlessObservabilityApmAgentsRubyApi" section="rails">hooking into Rails explicitly</DocLink>.
If you're not using Rails, see <DocLink id="serverlessObservabilityApmAgentsRubyGetStarted">Getting started with Rack</DocLink>.

<div id="api-agent-stop"></div>

### `ElasticAPM.stop`

Stop the currently running agent. Use this inside `at_exit` in your
<DocLink id="serverlessObservabilityApmAgentsRubyGetStarted">Rack app</DocLink> to gracefully shut down.

<div id="api-agent-restart"></div>

### `ElasticAPM.restart`

If the agent is already running, this method will stop and start the agent.

If the agent is not already running, this method will start the agent.

A config can be passed to the method that will be used to start the agent. If the agent
is already running and no config is passed to the `#restart` method, the running agent's
config will be used.

<div id="api-agent-running"></div>

### `ElasticAPM.running?`

Returns whether the ElasticAPM Agent is currently running.

<div id="api-agent-agent"></div>

### `ElasticAPM.agent`

Returns the currently running agent or nil.

## Instrumentation

<div id="api-agent-current-transaction"></div>

### `ElasticAPM.current_transaction`

Returns the current `ElasticAPM::Transaction` or nil.

<div id="api-agent-start_transaction"></div>

### `ElasticAPM.start_transaction`

Start a _transaction_ eg. an incoming web request or a background job.

```ruby
# call with block
ElasticAPM.start_transaction('Name')
do_work # ...
ElasticAPM.end_transaction('result')
```

Arguments:

  * `name`: A name for your transaction. Transactions are grouped by name. **Required**.
  * `type`: A `type` for your transaction eg. `db.postgresql.sql`.
  * `context:`: An optional <DocLink id="serverlessObservabilityApmAgentsRubyApi" section="context">Context</DocLink> used to enrich the
      transaction with information about the current request.

  * `trace_context:`: An optional `TraceContext` object for Distributed Tracing.

Returns the transaction.

<div id="api-agent-end_transaction"></div>

### `ElasticAPM.end_transaction`

Ends the currently running transaction.

Arguments:

  * `result`: A `String` result of the transaction, eg. `'success'`.

<div id="api-agent-with_transaction"></div>

### `ElasticAPM.with_transaction`

Wrap a block in a Transaction, starting and ending around the block

```ruby
ElasticAPM.with_transaction 'Do things' do |transaction|
  do_work # ...

  transaction.result = 'success'
end
```

Arguments:

  * `name`: A name for your transaction. Transactions are grouped by name. **Required**.
  * `type`: A `type` for your transaction eg. `db.postgresql.sql`.
  * `context:`: An optional <DocLink id="serverlessObservabilityApmAgentsRubyApi" section="context">Context</DocLink> used to enrich the
      transaction with information about the current request.

  * `trace_context:`: An optional `TraceContext` object for Distributed Tracing.
  * `&block`: A block to wrap. Optionally yields the transaction.

Returns the return value of the given block.

<div id="api-agent-start_span"></div>

### `ElasticAPM.start_span`

Start a new span.

```ruby
ElasticAPM.with_transaction 'Do things' do
  ElasticAPM.start_span 'Do one of the things'
  Database.query # ...
  ElasticAPM.end_span
end
```

Arguments:

  * `name`: A name for your span. **Required**.
  * `type`: The type of span eg. `db`.
  * `subtype`: The subtype of span eg. `postgresql`.
  * `action`: The action type of span eg. `connect` or `query`.
  * `context`: An instance of `Span::Context`.
  * `include_stacktrace`: Whether or not to collect a Stacktrace.
  * `trace_context:`: An optional `TraceContext` object for Distributed Tracing.
  * `parent:`: An optional parent transaction or span. Relevant when the span is created in another thread.
  * `sync:`: An boolean to indicate whether the span is created synchronously or not.
  * `&block`: An optional block to wrap with the span.
      The block is passed the span as an optional argument.

Returns the created span.

If you'd like to create an asynchronous span, you have to pass the parent `Span` or `Transaction` to the `start_span` method.
You can also set the `sync` flag to `false`, if you'd like the span to be marked as asynchronous. This has no effect other than being queryable in Elasticsearch.

```ruby
transaction = ElasticAPM.current_transaction # or start one with `.start_transaction`
Thread.new do
  ElasticAPM.start_span(
    'job 1',
    parent: transaction,
    sync: false
  ) { Worker.perform }
  ElasticAPM.end_span
end
```

<div id="api-agent-end_span"></div>

### `ElasticAPM.end_span`

Ends the currently running span.

<div id="api-agent-with_span"></div>

### `ElasticAPM.with_span`

Wraps a block in a Span.

Arguments:

  * `name`: A name for your span. **Required**.
  * `type`: The type of span eg. `db`.
  * `subtype`: The subtype of span eg. `postgresql`.
  * `action`: The action type of span eg. `connect` or `query`.
  * `context`: An instance of `Span::Context`.
  * `include_stacktrace`: Whether or not to collect a Stacktrace.
  * `trace_context:`: An optional `TraceContext` object for Distributed Tracing.
  * `parent:`: An optional parent transaction or span. Relevant when the span is created in another thread.
  * `sync:`: An boolean to indicate whether the span is created synchronously or not.
  * `&block`: An optional block to wrap with the span.
      The block is passed the span as an optional argument.

Returns the return value of the given block.

If you'd like to create an asynchronous span, you have to pass the parent `Span` or `Transaction` to the `with_span` method.
You can also set the `sync` flag to `false`, if you'd like the span to be marked as asynchronous.

```ruby
transaction = ElasticAPM.current_transaction # or start one with `.start_transaction`
Thread.new do
  ElasticAPM.with_span(
    'job 1',
    parent: transaction,
    sync: false
  ) { Worker.perform }
end
```

<div id="api-agent-build-context"></div>

### `ElasticAPM.build_context`

Build a new _Context_ from a Rack `env`.

A context provides information about the current request, response, user and more.

Arguments:

  * `rack_env`: An instance of Rack::Env
  * `for_type`: Symbol representing type of event, eg. `:transaction` or `error`

Returns the built context.

<div id="rails-start"></div>

## Rails

Start the agent and hook into Rails manually. This is useful if you skip requiring
the gem and using the `Railtie`.

```ruby
ElasticAPM::Rails.start(server_url: 'http://localhost:8200')
```

<div id="sinatra-start"></div>

## Sinatra

Start the agent and hook into Sinatra.

```ruby
ElasticAPM::Sinatra.start(MySinatraApp, server_url: 'http://localhost:8200')
```

<div id="grape-start"></div>

## Grape

Start the agent and hook into Grape.

```ruby
ElasticAPM::Grape.start(MyGrapeApp, server_url: 'http://localhost:8200')
```

## Errors

<div id="api-agent-report"></div>

### `ElasticAPM.report`

Send an `Exception` to Elastic APM.

If reported inside a transaction, the context from that will be added.

```ruby
begin
  do_a_thing_and_fail
rescue Exception => e
  ElasticAPM.report(e)
end
```

Arguments:

  * `exception`: An instance of `Exception`. **Required**.
  * `handled`: Whether the error was _handled_ eg. wasn't rescued and was represented
      to the user. Default: `true`.

Returns `[String]` ID of the generated `[ElasticAPM::Error]` object.

<div id="api-agent-report-message"></div>

### `ElasticAPM.report_message`

Send a custom message to Elastic APM.

If reported inside a transaction, the context from that will be added.

```ruby
ElasticAPM.report_message('This should probably never happen?!')
```

Arguments:

  * `message`: A custom error string. **Required**.

Returns `[String]` ID of the generated `[ElasticAPM::Error]` object.

<div id="api-context"></div>

## Context

<div id="api-agent-set-label"></div>

### `ElasticAPM.set_label`

Add a label to the current transaction.
Labels are basic key-value pairs that are indexed in your Elasticsearch database and therefore searchable.
The value can be a string, nil, numeric or boolean.

<DocCallOut title="Tip">
Before using custom labels, ensure you understand the different types of
[metadata](((apm-guide-ref))/data-model-metadata.html) that are available.
</DocCallOut>

```ruby
before_action do
  ElasticAPM.set_label(:company_id, current_user.company.id)
end
```

Arguments:

  * `key`: A string key. Note that `.`, `*` or `"` will be converted to `_`.
  * `value`: A value.

Returns the set `value`.

<DocCallOut title="Warning" color="warning">
Be aware that labels are indexed in Elasticsearch. Using too many unique keys will result in **https://www.elastic.co/blog/found-crash-elasticsearch#mapping-explosion[Mapping explosion]**.
</DocCallOut>

<div id="api-agent-set-custom-context"></div>

### `ElasticAPM.set_custom_context`

Add custom context to the current transaction.
Use this to further specify a context that will help you track or diagnose what's
going on inside your app.

<DocCallOut title="Tip">
Before using custom context, ensure you understand the different types of
[metadata](((apm-guide-ref))/data-model-metadata.html) that are available.
</DocCallOut>

If called several times during a transaction the custom context will be destructively
merged with `merge!`.

```ruby
before_action do
  ElasticAPM.set_custom_context(company: current_user.company.to_h)
end
```

Arguments:

  * `context`: A hash of JSON-compatible key-values. Can be nested.

Returns current custom context.

<div id="api-agent-set-user"></div>

### `ElasticAPM.set_user`

Add the current user to the current transaction's context.

Arguments:

  * `user`: An object representing the user

Returns the given user

## Data

<div id="api-agent-add-filter"></div>

### `ElasticAPM.add_filter`

Provide a filter to transform payloads before sending.

Arguments:

  * `key`: A unique key identifying the filter
  * `callable`: An object or proc (responds to `.call(payload)`)

Return the altered payload.

If `nil` is returned all subsequent filters will be skipped and the post request cancelled.

Example:

```ruby
ElasticAPM.add_filter(:filter_pings) do |payload|
  payload[:transactions]&.reject! do |t|
    t[:name] == 'PingsController#index'
  end
  payload
end
```

<div id="api-transaction"></div>

## Transaction

`ElasticAPM.transaction` returns a `Transaction` (if the agent is running).

### Properties

- `name`: String
- `type`: String
- `result`: String
- `outcome`: String ('unknown', 'success', 'failure', nil)
- `trace_id`: String (readonly)

<div id="api-transaction-sampled_"></div>

### `#sampled?`

Whether the transaction is _sampled_ eg. it includes stacktraces for its spans.

<div id="api-transaction-ensure_parent_id"></div>

### `#ensure_parent_id`

If the transaction does not have a parent-ID yet, calling this method generates
a new ID, sets it as the parent-ID of this transaction, and returns it as a
`String`.

This enables the correlation of the spans the JavaScript Real User Monitoring
(RUM) agent creates for the initial page load with the transaction of the
backend service.

If your service generates the HTML page dynamically, initializing the
JavaScript RUM agent with the value of this method allows analyzing the time
spent in the browser vs in the backend services.

To enable the JavaScript RUM agent, initialize the RUM agent with the Ruby
agent's current transaction:

```html
<script src="elastic-apm-js-base/dist/bundles/elastic-apm-js-base.umd.min.js"></script>
<script>
  var elasticApm = initApm({
    serviceName: '',
    serverUrl: 'http://localhost:8200',
    pageLoadTraceId: "<%= ElasticAPM.current_transaction&.trace_id %>",
    pageLoadSpanId: "<%= ElasticAPM.current_transaction&.ensure_parent_id %>",
    pageLoadSampled: <%= ElasticAPM.current_transaction&.sampled? %>
  })
</script>
```
See the [JavaScript RUM agent documentation](((apm-rum-ref))) for more information.

<div id="api-span"></div>

## Span

### Properties

- `name`: String
- `type`: String
