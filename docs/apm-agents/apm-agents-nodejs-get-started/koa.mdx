

import SharedSetUpIntroduction from '../../transclusion/apm/agent/nodejs/shared-set-up/introduction.mdx'
import SharedSetUpAdvancedConfiguration from '../../transclusion/apm/agent/nodejs/shared-set-up/advanced-configuration.mdx'
import SharedSetUpPerformanceMonitoring from '../../transclusion/apm/agent/nodejs/shared-set-up/performance-monitoring.mdx'
import SharedSetUpUnknownRoots from '../../transclusion/apm/agent/nodejs/shared-set-up/unknown-roots.mdx'
import SharedSetUpErrorLogging from '../../transclusion/apm/agent/nodejs/shared-set-up/error-logging.mdx'
import SharedSetUpFilterSensitiveInfo from '../../transclusion/apm/agent/nodejs/shared-set-up/filter-sensitive-info.mdx'
import SharedSetUpAddYourOwnData from '../../transclusion/apm/agent/nodejs/shared-set-up/add-your-own-data.mdx'
import SharedSetUpCompatibilityLink from '../../transclusion/apm/agent/nodejs/shared-set-up/compatibility-link.mdx'
import SharedSetUpTroubleshootingLink from '../../transclusion/apm/agent/nodejs/shared-set-up/troubleshooting-link.mdx'

export let framework = "Koa"

<div id="koa"></div>

export let env_github = false

<DocIf condition={ env_github === true }>

<DocCallOut title="Note">
For the best reading experience,
please view this documentation at [elastic.co](https://www.elastic.co/guide/en/apm/agent/nodejs/current/koa.html)
</DocCallOut>

</DocIf>

<SharedSetUpIntroduction framework={framework} />

Koa doesn't have a built-in router,
so we can't support Koa directly since we rely on router information for full support.
We currently support the most popular Koa router called [koa-router](https://github.com/koajs/koa-router).

If you use another router with your Koa application,
please [open an issue](https://github.com/elastic/apm-agent-nodejs/issues) so we can make sure to support your stack.
In the meantime, you can <DocLink id="serverlessObservabilityApmAgentsNodejsGetStarted">configure Elastic APM to work with any stack</DocLink>.

<div id="koa-installation"></div>

### Installation

Add the `elastic-apm-node` module as a dependency to your application:

```bash
npm install elastic-apm-node --save
```

<div id="koa-initialization"></div>

### Initialization

It's important that the agent is started before you require **any** other modules in your Node.js application - i.e. before `koa`, `http`, etc.

This means that you should probably require and start the agent in your application's main file (usually `index.js`, `server.js` or `app.js`).

Here's a simple Koa example with the Elastic APM agent installed:

```js
// Add this to the VERY top of the first file loaded in your app
const apm = require('elastic-apm-node').start({
  // Override service name from package.json
  // Allowed characters: a-z, A-Z, 0-9, -, _, and space
  serviceName: '',

  // Use if APM Server requires a token
  secretToken: '',

  // Use if APM Server uses API keys for authentication
  apiKey: '',

  // Set custom APM Server URL (default: http://127.0.0.1:8200)
  serverUrl: '',
})

const app = require('koa')()
const router = require('koa-router')()

router.get('/', function *(next) {
  this.body = 'Hello World'
})

app
  .use(router.routes())
  .use(router.allowedMethods())

app.listen(3000)
```

The agent will now monitor the performance of your Koa application and record any uncaught exceptions.

<div id="koa-advanced-configuration"></div>

#### Advanced configuration

<SharedSetUpAdvancedConfiguration />

<div id="koa-full-documentation"></div>

#### Full documentation

* <DocLink id="serverlessObservabilityApmAgentsNodejsConfigure">Setup and Configuration</DocLink>
* <DocLink id="serverlessObservabilityApmAgentsNodejsApi">API Reference</DocLink>

<div id="koa-performance-monitoring"></div>

### Performance monitoring

<SharedSetUpPerformanceMonitoring framework={framework}  />

<div id="koa-unknown-routes"></div>

#### Unknown routes

<SharedSetUpUnknownRoots framework={framework}  />

<div id="koa-error-logging"></div>

### Error logging

<SharedSetUpErrorLogging />

<div id="koa-filter-sensitive-information"></div>

### Filter sensitive information

<SharedSetUpFilterSensitiveInfo />

<div id="koa-add-your-own-data"></div>

### Add your own data

<SharedSetUpAddYourOwnData />

<div id="koa-compatibility"></div>

### Compatibility

<SharedSetUpCompatibilityLink />

<div id="koa-troubleshooting"></div>

### Troubleshooting

<SharedSetUpTroubleshootingLink />
