


<div id="setup-azure-functions"></div>

The .NET APM Agent can trace function invocations in an [Azure Functions](https://learn.microsoft.com/en-us/azure/azure-functions) app.

### Prerequisites

You need an APM Server to send APM data to. Follow the
[APM Quick start](((apm-guide-ref))/apm-quick-start.html) if you have not set one up
yet. You will need your **APM server URL** and an APM server **secret token** (or
**API key**) for configuring the APM agent below.

You will also need an Azure Function app to monitor. If you do not have an
existing one, you can follow [this Azure guide](https://learn.microsoft.com/en-us/azure/azure-functions/create-first-function-cli-csharp)
to create one.

You can also take a look at and use this
[Azure Functions example app with Elastic APM already integrated](https://github.com/elastic/apm-agent-dotnet/tree/1.x/sample/Elastic.AzureFunctionApp.Isolated).

<DocCallOut title="Important" color="warning">

Currently, only .NET Azure Functions in an
[isolated worker process](https://learn.microsoft.com/en-us/azure/azure-functions/dotnet-isolated-process-guide)
can be traced.

</DocCallOut>

<div id="azure-functions-setup"></div>

### Step 1: Add the NuGet package

Add the `Elastic.Apm.Azure.Functions` NuGet package to your Azure Functions project:

```bash
dotnet add package Elastic.Apm.Azure.Functions
```

### Step 2: Add the tracing Middleware

For the APM agent to trace Azure Functions invocations, the `Elastic.Apm.Azure.Functions.ApmMiddleware`
must be used in your Azure Functions app.

```c#
using Elastic.Apm.Azure.Functions;
using Microsoft.Extensions.Hosting;

var host = new HostBuilder()
	.ConfigureFunctionsWorkerDefaults(builder =>
	{
		builder.UseMiddleware<ApmMiddleware>();
	})
	.Build();

host.Run();
```

### Step 3: Configure the APM agent

The APM agent can be configured with environment variables. Using environment variables
allows you to use [application settings in the Azure Portal](https://learn.microsoft.com/en-us/azure/azure-functions/functions-how-to-use-azure-function-app-settings?tabs=portal#settings), enabling you to hide values and update settings
without needing to re-deploy code.

Open _Configuration > Application settings_ for your Function App in the Azure Portal
and set:

```yaml
ELASTIC_APM_SERVER_URL: <your APM server URL from the prerequisites step>
ELASTIC_APM_SECRET_TOKEN: <your APM secret token from the prerequisites step>
```

For example:

<div style={{ backgroundColor: "#F1F4FA", width: "100%", height: "250px", textAlign: "center", paddingTop: "110px", marginBottom: "20px" }}><DocIcon type="image" title="missing image"/> missing image</div>
{/* ![Configuring the APM Agent in the Azure Portal](images/setup-azure-functions/-azure-functions-configuration.png) */}

<div id="azure-functions-limitations"></div>

### Limitations

Azure Functions instrumentation currently does _not_ collect system metrics in
the background because of a concern with unintentionally increasing Azure
Functions costs (for Consumption plans).
