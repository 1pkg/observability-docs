---
id: serverlessObservabilityApmAgentsNetPerformanceTuning
slug: /serverless/observability/apm-agents-net-performance-tuning
title: Performance tuning
# description: Description to be written
tags: [ 'serverless', 'observability', '' ]
---



export let env_github = false

<DocIf condition={ env_github === true }>

<DocCallOut title="Note">
For the best reading experience,
please view this documentation at [elastic.co](https://www.elastic.co/guide/en/apm/agent/dotnet/current/performance-tuning.html)
</DocCallOut>

</DocIf>

<div id="performance-tuning"></div>

There are many options available to tune agent performance.
Which option to adjust depends on whether you are optimizing for speed, memory usage, bandwidth or storage.

<div id="performance-tuning-sampling"></div>

## Sampling

The first knob to reach for when tuning the performance of the agent is <DocLink id="serverlessObservabilityApmAgentsNetConfigure" section="transactionsamplerate">`TransactionSampleRate`</DocLink>.
Adjusting the sample rate controls what percent of requests are traced.
By default, the sample rate is set at `1.0`, meaning _all_ requests are traced.

The sample rate will impact all four performance categories,
so simply turning down the sample rate is an easy way to improve performance.

Here's an example of setting the sample rate to 20% using <DocBadge><DocIcon size="s" type="unlink" title="missing link"/> missing link</DocBadge>{/*  <DocLink id="enApmAgentDotnetConfigurationOnAspNetCore">Configuration on ASP.NET Core</DocLink> */}:

```js
{
    "ElasticApm": {
        "TransactionSampleRate": 0.2
    }
}
```

<div id="performance-tuning-stack-traces"></div>

## Stack traces

In a complex application,
a request may produce many spans.
Capturing a stack trace for every span can result in significant memory usage.
Stack traces are also captured for every error.
There are several settings to adjust how stack traces are captured.

<div id="performance-tuning-disable-capturing-stack-traces"></div>

### Disable capturing stack traces

To disable capturing stack traces (for both spans and errors),
set <DocLink id="serverlessObservabilityApmAgentsNetConfigure" section="stacktracelimit-performance">`StackTraceLimit`</DocLink> to `0`.

<div id="performance-tuning-stack-traces-for-long-running-spans"></div>

### Capture stack traces only for long running spans

In its default settings,
the APM agent collects a stack trace for every recorded span with duration longer than 5ms.
To increase the duration threshold,
set <DocLink id="serverlessObservabilityApmAgentsNetConfigure" section="spanstacktraceminduration-performance">`SpanStackTraceMinDuration`</DocLink>.

<div id="performance-tuning-stack-frame-limit"></div>

### Reduce number of captured stack trace frames 

The <DocLink id="serverlessObservabilityApmAgentsNetConfigure" section="stacktracelimit-performance">`StackTraceLimit`</DocLink> controls how many stack frames should be collected
when a capturing stack trace.

<div id="performance-tuning-disable-capture-headers"></div>

## Disable capturing HTTP request and response headers

Capturing HTTP request and response headers increases memory allocations,
network bandwidth and disk space used by Elasticsearch.
To disable capturing HTTP request and response headers,
set <DocLink id="serverlessObservabilityApmAgentsNetConfigure" section="captureheaders-performance">`CaptureHeaders`</DocLink> to `false`.

<div id="performance-tuning-increase-metrics-collection-interval"></div>

## Increase metrics collection interval

The .NET agent tracks certain system and application metrics.
These metrics are regularly collected and sent to the APM Server and from there to Elasticsearch.
You can adjust the interval for metrics collection with the setting <DocLink id="serverlessObservabilityApmAgentsNetConfigure" section="metricsinterval-added[100-beta1]">`MetricsInterval`</DocLink>.
