

import ApiUsingTheAPIs from '../../transclusion/kibana/apm/api/using-the-APIs.mdx'

<div id="agent-key-api"></div>

The APM agent Key API allows you to configure APM agent keys to authorize requests from APM agents to the APM Server.

The following APM agent key APIs are available:

* <DocLink id="serverlessObservabilityApmKibanaApi" section="create-agent-key">Create agent key</DocLink> to create an APM agent key

<div id="use-agent-key-api"></div>

### How to use APM APIs

<DocAccordion buttonContent="Expand for required headers, privileges, and usage details">

<ApiUsingTheAPIs />

</DocAccordion>

<div id="apm-create-agent-key"></div>

### Create agent key

Create an APM agent API key. Specify API key privileges in the request body at creation time.

<div id="apm-create-agent-key-privileges"></div>

#### Privileges

The user creating an APM agent API key must have at least the `manage_own_api_key` cluster privilege
and the APM application-level privileges that it wishes to grant.

##### Example role

The example below uses the Kibana <DocBadge><DocIcon size="s" type="unlink" title="missing link"/> missing link</DocBadge>{/*  <DocLink id="enKibanaRoleManagementApi">role management API</DocLink> */} to create a role named `apm_agent_key_user`.
Create and assign this role to a user that wishes to create APM agent API keys.

```js
POST /_security/role/apm_agent_key_user
{
  "cluster": ["manage_own_api_key"],
  "applications": [{
    "application": "apm",
    "privileges": ["event:write", "config_agent:read"],
    "resources": ["*"]
  }]
}
```

<div id="apm-create-agent-key-req"></div>

#### Request

`POST /api/apm/agent_keys`

<div id="apm-create-agent-key-req-body"></div>

#### Request body

`name` 
    : (required, string) Name of the APM agent key.

`privileges` 
    : (required, array) APM agent key privileges. It can take one or more of the following values:

  - `event:write`. Required for ingesting APM agent events.
  - `config_agent:read`. Required for APM agents to read agent configuration remotely.

<div id="apm-agent-key-create-example"></div>

#### Example

```curl
POST /api/apm/agent_keys
{
    "name": "apm-key",
    "privileges": ["event:write", "config_agent:read"]
}
```

<div id="apm-agent-key-create-body"></div>

#### Response body

```js
{
  "agentKey": {
    "id": "3DCLmn0B3ZMhLUa7WBG9",
    "name": "apm-key",
    "api_key": "PjGloCGOTzaZr8ilUPvkjA",
    "encoded": "M0RDTG1uMEIzWk1oTFVhN1dCRzk6UGpHbG9DR09UemFacjhpbFVQdmtqQQ=="
  }
}
```

