---
id: serverlessObservabilityApmAgentsOtelOtherExecutionEnvironments
slug: /serverless/observability/apm-agents-opentelemetry-other-execution-environments
title: Other execution environments
# description: Description to be written
tags: [ 'serverless', 'observability', 'how-to' ]
---


<div id="open-telemetry-other-env"></div>

    * <DocLink id="serverlessObservabilityApmAgentsOtelOtherExecutionEnvironments" section="aws-lambda-support">AWS Lambda Support</DocLink>
    * <DocLink id="serverlessObservabilityApmAgentsOtelOtherExecutionEnvironments" section="instrumenting-aws-lambda-java-functions-with-terraform">Instrumenting AWS Lambda Java functions with Terraform</DocLink>
    * <DocLink id="serverlessObservabilityApmAgentsOtelOtherExecutionEnvironments" section="instrumenting-aws-lambda-nodejs-functions">Instrumenting AWS Lambda Node.js functions</DocLink>
    * <DocLink id="serverlessObservabilityApmAgentsOtelOtherExecutionEnvironments" section="instrumenting-aws-lambda-nodejs-functions-with-terraform">Instrumenting AWS Lambda Node.js functions with Terraform</DocLink>

<div id="open-telemetry-aws-lambda"></div>

## AWS Lambda Support

AWS Lambda functions can be instrumented with OpenTelemetry and monitored with Elastic ((observability)).

To get started, follow the official AWS Distro for OpenTelemetry Lambda [getting started documentation](https://aws-otel.github.io/docs/getting-started/lambda) and configure the OpenTelemetry Collector to output traces and metrics to your Elastic cluster.

<div id="open-telemetry-aws-lambda-java"></div>

### Instrumenting AWS Lambda Java functions

<DocCallOut title="Note">
For a better startup time, we recommend using SDK-based instrumentation, i.e. manual instrumentation of the code, rather than auto instrumentation.
</DocCallOut>

To instrument AWS Lambda Java functions, follow the official [AWS Distro for OpenTelemetry Lambda Support For Java](https://aws-otel.github.io/docs/getting-started/lambda/lambda-java).

Noteworthy configuration elements:

* AWS Lambda Java functions should extend `com.amazonaws.services.lambda.runtime.RequestHandler`,

    ```java
    public class ExampleRequestHandler implements RequestHandler<APIGatewayProxyRequestEvent, APIGatewayProxyResponseEvent> {
    public APIGatewayProxyResponseEvent handleRequest(APIGatewayProxyRequestEvent event, Context context) {
    // add your code ...
    }

    ```

* When using SDK-based instrumentation, frameworks you want to gain visibility of should be manually instrumented
    * The below example instruments [OkHttpClient](https://square.github.io/okhttp/4.x/okhttp/okhttp3/-ok-http-client/) with the OpenTelemetry instrument [io.opentelemetry.instrumentation:opentelemetry-okhttp-3.0:1.3.1-alpha](https://search.maven.org/artifact/io.opentelemetry.instrumentation/opentelemetry-okhttp-3.0/1.3.1-alpha/jar)

        ```java
        import io.opentelemetry.instrumentation.okhttp.v3_0.OkHttpTracing;

        OkHttpClient httpClient = new OkHttpClient.Builder()
        .addInterceptor(OkHttpTracing.create(GlobalOpenTelemetry.get()).newInterceptor())
        .build();
        ```

* The configuration of the OpenTelemetry Collector, with the definition of the Elastic ((observability)) endpoint, can be added to the root directory of the Lambda binaries (e.g. defined in `src/main/resources/opentelemetry-collector.yaml`)

    ```yaml
    # Copy opentelemetry-collector.yaml in the root directory of the lambda function
    # Set an environment variable 'OPENTELEMETRY_COLLECTOR_CONFIG_FILE' to '/var/task/opentelemetry-collector.yaml'
    receivers:
    otlp:
    protocols:
    http:
    grpc:

    exporters:
    logging:
    loglevel: debug
    otlp/elastic:
    # Elastic APM server https endpoint without the "https://" prefix
    endpoint: "${ELASTIC_OTLP_ENDPOINT}"  [^1]
    headers:
    # Elastic APM Server secret token
    Authorization: "Bearer ${ELASTIC_OTLP_TOKEN}"  [^1]

    service:
    pipelines:
    traces:
    receivers: [otlp]
    exporters: [logging, otlp/elastic]
    metrics:
    receivers: [otlp]
    exporters: [logging, otlp/elastic]
    logs:
    receivers: [otlp]
    exporters: [logging, otlp/elastic]
    ```
    [^1]: Environment-specific configuration parameters can be conveniently passed in as environment variables: `ELASTIC_OTLP_ENDPOINT` and `ELASTIC_OTLP_TOKEN`

* Configure the AWS Lambda Java function with:
    * [Function
        layer](https://docs.aws.amazon.com/lambda/latest/dg/API_Layer.html): The latest [AWS
        Lambda layer for OpenTelemetry](https://aws-otel.github.io/docs/getting-started/lambda/lambda-java) (e.g. `arn:aws:lambda:eu-west-1:901920570463:layer:aws-otel-java-wrapper-ver-1-2-0:1`)

    * [`TracingConfig` / Mode](https://docs.aws.amazon.com/lambda/latest/dg/API_TracingConfig.html) set to `PassTrough`
    * [`FunctionConfiguration` / Timeout](https://docs.aws.amazon.com/lambda/latest/dg/API_FunctionConfiguration.html) set to more than 10 seconds to support the longer cold start inherent to the Lambda Java Runtime
    * Export the environment variables:
        * `AWS_LAMBDA_EXEC_WRAPPER="/opt/otel-proxy-handler"` for wrapping handlers proxied through the API Gateway (see [here](https://aws-otel.github.io/docs/getting-started/lambda/lambda-java#enable-auto-instrumentation-for-your-lambda-function))
        * `OTEL_PROPAGATORS="tracecontext, baggage"` to override the default setting that also enables X-Ray headers causing interferences between OpenTelemetry and X-Ray
        * `OPENTELEMETRY_COLLECTOR_CONFIG_FILE="/var/task/opentelemetry-collector.yaml"` to specify the path to your OpenTelemetry Collector configuration

<div id="open-telemetry-aws-lambda-java-terraform"></div>

### Instrumenting AWS Lambda Java functions with Terraform

We recommend using an infrastructure as code solution like Terraform or Ansible to manage the configuration of your AWS Lambda functions.

Here is an example of AWS Lambda Java function managed with Terraform and the [AWS Provider / Lambda Functions](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_function):

* Sample Terraform code: https://github.com/cyrille-leclerc/my-serverless-shopping-cart/tree/main/checkout-function/deploy
* Note that the Terraform code to manage the HTTP API Gateway ([here](https://github.com/cyrille-leclerc/my-serverless-shopping-cart/tree/main/utils/terraform/api-gateway-proxy)) is copied from the official OpenTelemetry Lambda sample [here](https://github.com/open-telemetry/opentelemetry-lambda/tree/e72467a085a2a6e57af133032f85ac5b8bbbb8d1/utils)

<div id="open-telemetry-aws-lambda-nodejs"></div>

### Instrumenting AWS Lambda Node.js functions

<DocCallOut title="Note">
For a better startup time, we recommend using SDK-based instrumentation for manual instrumentation of the code rather than auto instrumentation.
</DocCallOut>

To instrument AWS Lambda Node.js functions, see [AWS Distro for OpenTelemetry Lambda Support For JavaScript](https://aws-otel.github.io/docs/getting-started/lambda/lambda-js).

The configuration of the OpenTelemetry Collector, with the definition of the Elastic ((observability)) endpoint, can be added to the root directory of the Lambda binaries: `src/main/resources/opentelemetry-collector.yaml`.

```yaml
# Copy opentelemetry-collector.yaml in the root directory of the lambda function
# Set an environment variable 'OPENTELEMETRY_COLLECTOR_CONFIG_FILE' to '/var/task/opentelemetry-collector.yaml'
receivers:
  otlp:
    protocols:
      http:
      grpc:

exporters:
  logging:
    loglevel: debug
  otlp/elastic:
    # Elastic APM server https endpoint without the "https://" prefix
    endpoint: "${ELASTIC_OTLP_ENDPOINT}"  [^1]
    headers:
      # Elastic APM Server secret token
      Authorization: "Bearer ${ELASTIC_OTLP_TOKEN}"  [^1]

service:
  pipelines:
    traces:
      receivers: [otlp]
      exporters: [logging, otlp/elastic]
    metrics:
      receivers: [otlp]
      exporters: [logging, otlp/elastic]
    logs:
      receivers: [otlp]
      exporters: [logging, otlp/elastic]
```
[^1]: Environment-specific configuration parameters can be conveniently passed in as environment variables: `ELASTIC_OTLP_ENDPOINT` and `ELASTIC_OTLP_TOKEN`

Configure the AWS Lambda Node.js function:

* [Function
    layer](https://docs.aws.amazon.com/lambda/latest/dg/API_Layer.html): The latest [AWS
    Lambda layer for OpenTelemetry](https://aws-otel.github.io/docs/getting-started/lambda/lambda-js). For example, `arn:aws:lambda:eu-west-1:901920570463:layer:aws-otel-nodejs-ver-0-23-0:1`)

* [`TracingConfig` / Mode](https://docs.aws.amazon.com/lambda/latest/dg/API_TracingConfig.html) set to `PassTrough`
* [`FunctionConfiguration` / Timeout](https://docs.aws.amazon.com/lambda/latest/dg/API_FunctionConfiguration.html) set to more than 10 seconds to support the cold start of the Lambda JavaScript Runtime
* Export the environment variables:
    * `AWS_LAMBDA_EXEC_WRAPPER="/opt/otel-handler"` for wrapping handlers proxied through the API Gateway. See [enable auto instrumentation for your lambda-function](https://aws-otel.github.io/docs/getting-started/lambda/lambda-js#enable-auto-instrumentation-for-your-lambda-function).
    * `OTEL_PROPAGATORS="tracecontext"` to override the default setting that also enables X-Ray headers causing interferences between OpenTelemetry and X-Ray
    * `OPENTELEMETRY_COLLECTOR_CONFIG_FILE="/var/task/opentelemetry-collector.yaml"` to specify the path to your OpenTelemetry Collector configuration.
    * `OTEL_TRACES_SAMPLER="AlwaysOn"` define the required sampler strategy if it is not sent from the caller. Note that `Always_on` can potentially create a very large amount of data, so in production set the correct sampling configuration, as per the [specification](https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/trace/sdk.md#sampling).

<div id="open-telemetry-aws-lambda-nodejs-terraform"></div>

### Instrumenting AWS Lambda Node.js functions with Terraform

To manage the configuration of your AWS Lambda functions, we recommend using an infrastructure as code solution like Terraform or Ansible.

Here is an example of AWS Lambda Node.js function managed with Terraform and the [AWS Provider / Lambda Functions](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_function):

* [Sample Terraform code](https://github.com/michaelhyatt/terraform-aws-nodejs-api-worker-otel/tree/v0.24)

<div id="open-telemetry-lambda-next"></div>

### Next steps

* <DocLink id="serverlessObservabilityApmAgentsOtelCollectMetrics">Collect metrics</DocLink>
* Add <DocLink id="serverlessObservabilityApmAgentsOtelResourceAttributes">Resource attributes</DocLink>
* Learn about the <DocLink id="serverlessObservabilityApmAgentsOtelLimitations">limitations of this integration</DocLink>

